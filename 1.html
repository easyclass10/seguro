<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sentinel AI - Optimizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry { animation: fadeIn 0.2s ease-in; border-bottom: 1px solid #333; padding: 4px 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        html, body { overscroll-behavior-y: contain; touch-action: manipulation; background: #0a0a0a; }
        #webcam { filter: brightness(1.1) contrast(1.1); }
    </style>
</head>
<body class="text-green-400 font-mono p-4 text-center min-h-screen flex flex-col items-center select-none">
    
    <h1 class="text-2xl font-bold mb-3 text-red-500 uppercase tracking-tighter animate-pulse">‚ö†Ô∏è Sentinel AI Security v2</h1>
    
    <div class="relative inline-block border-2 border-green-600 shadow-[0_0_15px_rgba(0,255,0,0.3)] bg-black rounded-lg overflow-hidden">
        <video id="webcam" autoplay playsinline muted class="w-[480px] max-w-full h-auto transform scale-x-[-1]"></video>
        <div id="recording-dot" class="absolute top-2 right-2 w-3 h-3 bg-red-600 rounded-full animate-ping"></div>
        <div class="absolute bottom-2 left-2 bg-black/70 px-2 py-1 text-[10px] text-white">PROCESO IA ACTIVO</div>
    </div>

    <div class="flex gap-2 mt-3">
        <button onclick="switchCamera()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold">üì∑ Girar</button>
        <button id="wake-lock-btn" onclick="toggleWakeLock()" class="bg-amber-600 text-white px-4 py-2 rounded text-sm font-bold">üîã Pantalla</button>
    </div>

    <div class="mt-4 w-full max-w-md bg-gray-900 border border-green-900 rounded-lg p-3">
        <form onsubmit="event.preventDefault(); updateCustomDetections();" class="flex gap-2">
            <input id="custom-detect-input" type="text" class="flex-1 bg-black border border-green-800 text-green-400 px-3 py-2 text-sm rounded focus:outline-none" placeholder="Ej: persona armada, fuego...">
            <button type="submit" class="bg-green-700 text-white px-3 rounded text-xs font-bold">SET</button>
        </form>
        <div id="custom-status" class="text-[9px] text-green-700 mt-1 uppercase"></div>
    </div>

    <div class="mt-4 w-full max-w-4xl bg-gray-900 border border-gray-700 rounded-lg overflow-hidden text-left shadow-2xl">
        <div class="bg-gray-800 p-2 flex justify-between items-center px-4 border-b border-gray-700">
            <span id="dash-status" class="text-xs font-bold flex items-center">
                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2 animate-pulse"></span> SISTEMA LISTO
            </span>
            <span id="dash-clock" class="text-xs text-yellow-500">00:00:00</span>
        </div>
        
        <div class="p-3 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="md:col-span-2 bg-black p-3 rounded border border-gray-800">
                <p class="text-[10px] text-gray-500 uppercase mb-1">√öltimo An√°lisis de Gemini:</p>
                <div id="dash-analysis" class="text-xs text-white leading-relaxed italic">Esperando movimiento...</div>
            </div>
            <div class="bg-black p-3 rounded border border-gray-800 h-32 overflow-y-auto">
                <p class="text-[10px] text-gray-500 uppercase mb-1">Historial:</p>
                <div id="log-container" class="text-[9px] text-gray-400"></div>
            </div>
        </div>
    </div>

    <canvas id="canvas" class="hidden"></canvas>
    <audio id="alarm-sound" loop preload="auto">
        <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    </audio>

    <script>
        // === CONFIGURACI√ìN DE OPTIMIZACI√ìN ===
        const RENDER_API_URL = "https://seguridad-thxq.onrender.com/analyze"; 
        const MOTION_THRESHOLD = 40; // Sensibilidad de movimiento (menor = m√°s sensible)
        const PIXEL_SKIP = 8;        // Velocidad de escaneo de p√≠xeles
        const ANALYZE_COOLDOWN = 2000; // Espera entre an√°lisis exitosos (1 seg)
        const STBY_CHECK_RATE = 400;  // Frecuencia de chequeo de movimiento (0.4 seg)

        let previousFrameData = null;
        let isAnalyzing = false;
        let currentFacingMode = "environment";
        let customDetectionPrompt = localStorage.getItem('savedPrompt') || "";
        let wakeLock = null;

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const logContainer = document.getElementById('log-container');
        const dashAnalysis = document.getElementById('dash-analysis');
        const dashStatus = document.getElementById('dash-status');

        // Inicializar reloj
        setInterval(() => { document.getElementById('dash-clock').innerText = new Date().toLocaleTimeString(); }, 1000);

        function addLog(msg, type='info') {
            const div = document.createElement('div');
            div.className = `log-entry ${type==='alert'?'text-red-500':'text-gray-500'}`;
            div.innerText = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}`;
            logContainer.prepend(div);
            if(logContainer.children.length > 20) logContainer.lastChild.remove();
        }

        function updateStatus(text, colorClass, pingColor) {
            dashStatus.innerHTML = `<span class="w-2 h-2 ${pingColor} rounded-full mr-2 animate-ping"></span> ${text}`;
            dashStatus.className = `text-xs font-bold flex items-center ${colorClass}`;
        }

        // L√ìGICA PRINCIPAL: An√°lisis + Detecci√≥n de Movimiento
        async function analyzeFrame() {
            if (isAnalyzing) return;

            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            // 1. Detecci√≥n de movimiento ultra-r√°pida (en 64x48)
            const mW = 64; const mH = 48;
            canvas.width = mW; canvas.height = mH;
            ctx.drawImage(video, 0, 0, mW, mH);
            const currentFrame = ctx.getImageData(0, 0, mW, mH).data;

            let hasMotion = false;
            if (previousFrameData) {
                let diff = 0;
                for (let i = 0; i < currentFrame.length; i += 4 * PIXEL_SKIP) {
                    const d = Math.abs(currentFrame[i] - previousFrameData[i]) + 
                              Math.abs(currentFrame[i+1] - previousFrameData[i+1]) + 
                              Math.abs(currentFrame[i+2] - previousFrameData[i+2]);
                    if (d > MOTION_THRESHOLD) diff++;
                }
                if (diff > (currentFrame.length / (4 * PIXEL_SKIP)) * 0.05) hasMotion = true;
            }
            previousFrameData = currentFrame;

            if (!hasMotion) {
                updateStatus("STBY - SIN MOVIMIENTO", "text-gray-500", "bg-gray-700");
                setTimeout(analyzeFrame, STBY_CHECK_RATE);
                return;
            }

            // 2. Si hay movimiento -> Enviar a Gemini
            isAnalyzing = true;
            updateStatus("MOVIMIENTO DETECTADO", "text-yellow-500", "bg-yellow-500");

            // Redimensionar para IA (480px es el balance ideal calidad/tokens)
            const scale = 480 / video.videoWidth;
            canvas.width = 480;
            canvas.height = video.videoHeight * scale;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Comprimir (0.5 es suficiente para ver detalles)
            const dataUrl = canvas.toDataURL("image/jpeg", 0.5);

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                const response = await fetch(RENDER_API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ image: dataUrl, customPrompt: customDetectionPrompt }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const data = await response.json();

                if (data.description) {
                    dashAnalysis.innerHTML = `<span class="text-green-400">Gemini:</span> ${data.description}`;
                    if (data.suspicious) {
                        addLog("üö® AMENAZA", "alert");
                        document.getElementById('alarm-sound').play().catch(()=>{});
                        updateStatus("‚ö†Ô∏è AMENAZA CONFIRMADA", "text-red-500", "bg-red-600");
                    } else {
                        updateStatus("VIGILANCIA ACTIVA", "text-green-400", "bg-green-500");
                        document.getElementById('alarm-sound').pause();
                    }
                }
            } catch (e) {
                addLog("Error de red", "alert");
            } finally {
                isAnalyzing = false;
                setTimeout(analyzeFrame, ANALYZE_COOLDOWN);
            }
        }

        // --- Funciones de C√°mara y WakeLock ---
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: currentFacingMode, width: 640, height: 480 } 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => { analyzeFrame(); };
                addLog("C√°mara iniciada");
            } catch (e) { addLog("Error c√°mara: " + e.message, "alert"); }
        }

        window.switchCamera = async function() {
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
            if (currentFacingMode === 'user') video.classList.add('scale-x-[-1]');
            else video.classList.remove('scale-x-[-1]');
            setupCamera();
        }

        window.toggleWakeLock = async function() {
            if (wakeLock) { wakeLock.release(); wakeLock = null; addLog("Bloqueo apagado"); }
            else { 
                wakeLock = await navigator.wakeLock.request('screen'); 
                addLog("Pantalla bloqueada");
            }
        }

        window.updateCustomDetections = function() {
            customDetectionPrompt = document.getElementById('custom-detect-input').value;
            localStorage.setItem('savedPrompt', customDetectionPrompt);
            document.getElementById('custom-status').innerText = "‚úÖ Prompt: " + customDetectionPrompt;
            addLog("Prompt actualizado");
        }

        setupCamera();
    </script>
</body>
</html>