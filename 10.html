<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel Pro - Alarma 5 Min</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .log-entry { animation: fadeIn 0.3s ease-in; border-bottom: 1px solid #333; padding: 4px 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        canvas { position: absolute; top: 0; left: 0; z-index: 10; pointer-events: none; width: 100%; height: 100%; }
        video { width: 100%; height: 100%; object-fit: cover; }
        /* Animaci√≥n para el bot√≥n de alarma */
        @keyframes panic { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .panic-btn { animation: panic 0.5s infinite; }
    </style>
</head>
<body class="bg-gray-900 text-cyan-400 font-mono p-4 text-center min-h-screen flex flex-col items-center">

    <h1 class="text-2xl font-bold mb-3 text-cyan-500 uppercase tracking-widest">üëÅÔ∏è Sentinel 5-MIN</h1>
    
    <div class="relative w-full max-w-[640px] aspect-[4/3] border-4 border-cyan-700 shadow-[0_0_30px_rgba(0,255,255,0.3)] bg-black rounded-lg overflow-hidden">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="detection-canvas"></canvas>
        
        <div class="absolute top-3 right-3 flex gap-2">
            <div id="loading-spinner" class="w-4 h-4 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        
        <div id="alarm-overlay" class="hidden absolute inset-0 bg-red-500/30 flex items-center justify-center z-20">
            <div class="bg-black/80 p-4 rounded-xl border-2 border-red-500 text-red-500 font-bold text-2xl animate-pulse">
                üö® INTRUSO DETECTADO üö®<br>
                <span class="text-sm text-white">Sonando por 5 min...</span>
            </div>
        </div>
    </div>

    <div class="flex flex-wrap gap-2 justify-center mt-4 w-full max-w-md">
        <button onclick="window.switchCamera()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-lg font-bold border border-gray-600">
            <span>üîÑ</span> C√°mara
        </button>

        <button id="wakelock-btn" onclick="window.toggleWakeLock()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-lg font-bold border border-yellow-600/50">
            <span>‚ö°</span> Pantalla: <span id="wake-state">OFF</span>
        </button>
    </div>

    <button id="stop-alarm-btn" onclick="window.stopAlarmManually()" class="hidden w-full max-w-md mt-3 bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-bold text-xl border-4 border-red-800 panic-btn shadow-[0_0_20px_red]">
        üîï DETENER ALARMA YA
    </button>

    <div class="mt-3 flex gap-2 justify-center w-full max-w-md">
        <div class="bg-gray-800/80 p-2 rounded border border-gray-700 w-full">
            <p class="text-[10px] text-gray-500 uppercase">Estado IA</p>
            <div id="ai-status" class="text-sm font-bold text-yellow-400">Cargando...</div>
        </div>
    </div>

    <div class="mt-3 w-full max-w-md bg-black/50 border border-gray-800 p-2 text-left h-24 overflow-y-auto rounded" id="log-container">
        <div class="text-gray-600 text-[10px] mb-1">--- REGISTRO DE EVENTOS ---</div>
    </div>

    <audio id="alarm-sound" loop preload="auto">
        <source src="police-siren-sound-effect-317645.mp3" type="audio/mp3">
    </audio>

    <script type="module">
        import { ObjectDetector, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/+esm";

        const CONFIDENCE_THRESHOLD = 0.50;
        const MODEL_ASSET_PATH = "https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite";
        
        // === CONFIGURACI√ìN DE TIEMPO ===
        const ALARM_DURATION_MS = 300000; // 5 Minutos = 300,000 ms
        let alarmTimeout = null; // Variable para guardar el temporizador

        let objectDetector = null;
        let runningMode = "VIDEO";
        let lastVideoTime = -1;
        let isAlarmActive = false;
        let wakeLock = null;
        let currentFacingMode = "environment";

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('detection-canvas');
        const ctx = canvas.getContext('2d');
        const aiStatus = document.getElementById('ai-status');
        const logContainer = document.getElementById('log-container');
        const alarmSound = document.getElementById('alarm-sound');
        const loadingSpinner = document.getElementById('loading-spinner');
        const alarmOverlay = document.getElementById('alarm-overlay');
        const stopBtn = document.getElementById('stop-alarm-btn');

        function addLog(msg, type='info') {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            div.className = `log-entry ${type === 'alert' ? 'text-red-500 font-bold' : 'text-gray-400'} text-xs`;
            div.innerText = `[${time}] ${msg}`;
            logContainer.prepend(div);
        }

        // 1. INICIALIZAR MOTOR IA
        async function initializeObjectDetector() {
            try {
                addLog("Iniciando IA...", "info");
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/wasm"
                );
                objectDetector = await ObjectDetector.createFromOptions(vision, {
                    baseOptions: { modelAssetPath: MODEL_ASSET_PATH, delegate: "GPU" },
                    scoreThreshold: CONFIDENCE_THRESHOLD,
                    runningMode: runningMode
                });
                loadingSpinner.style.display = 'none';
                aiStatus.innerText = "VIGILANCIA ACTIVA";
                aiStatus.className = "text-sm font-bold text-green-400";
                renderLoop();
            } catch (error) {
                addLog("Error Fatal IA: " + error.message, "alert");
            }
        }

        // 2. BUCLE DE DETECCI√ìN
        async function renderLoop() {
            if (!objectDetector || !video || video.readyState < 2) {
                requestAnimationFrame(renderLoop);
                return;
            }

            if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            if (video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                try {
                    const detections = objectDetector.detectForVideo(video, performance.now());
                    displayVideoDetections(detections);
                } catch(e) {}
            }
            requestAnimationFrame(renderLoop);
        }

        function displayVideoDetections(result) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let personDetected = false;

            for (let detection of result.detections) {
                const category = detection.categories[0];
                const label = category.categoryName;
                const box = detection.boundingBox;

                // Solo dibujamos personas en Rojo
                if (label === 'person') {
                    personDetected = true;
                    ctx.strokeStyle = '#FF0033'; 
                    ctx.lineWidth = 4;
                    ctx.strokeRect(box.originX, box.originY, box.width, box.height);
                    ctx.fillStyle = '#FF0033';
                    ctx.font = 'bold 20px Arial';
                    ctx.fillText("INTRUSO", box.originX, box.originY - 10);
                }
            }
            
            triggerAlarmLogic(personDetected);
        }

        // === 3. L√ìGICA DE ALARMA DE 5 MINUTOS ===
        function triggerAlarmLogic(isPerson) {
            if (isPerson) {
                // Si detecta persona, SIEMPRE reinicia o inicia el temporizador
                
                // 1. Si no estaba activa, la activamos
                if (!isAlarmActive) {
                    isAlarmActive = true;
                    alarmSound.play().catch(() => {});
                    if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
                    
                    // Actualizar UI
                    aiStatus.innerText = "‚ö†Ô∏è ALARMA: SONANDO 5 MIN";
                    aiStatus.className = "text-sm font-bold text-red-500 animate-pulse";
                    alarmOverlay.classList.remove('hidden');
                    stopBtn.classList.remove('hidden'); // Mostrar bot√≥n de detener
                    addLog("üö® INTRUSO - Alarma activada 5m", "alert");
                }

                // 2. Reiniciamos el temporizador de apagado
                // Si la persona sigue ah√≠, el temporizador vuelve a empezar.
                // La alarma solo se apagar√° 5 minutos DESPU√âS de la √∫ltima vez que vio a alguien.
                if (alarmTimeout) clearTimeout(alarmTimeout);

                alarmTimeout = setTimeout(() => {
                    stopAlarmAutomatic();
                }, ALARM_DURATION_MS);
            }
            
            // NOTA: No hay "else". Si no hay persona, NO apagamos la alarma.
            // Dejamos que el temporizador (setTimeout) se encargue.
        }

        function stopAlarmAutomatic() {
            addLog("‚è∞ Tiempo finalizado (5 min). Silenciando.", "info");
            resetAlarmState();
        }

        // Funci√≥n para apagar todo y resetear UI
        function resetAlarmState() {
            isAlarmActive = false;
            alarmSound.pause();
            alarmSound.currentTime = 0;
            
            // Limpiar temporizador pendiente si existe
            if (alarmTimeout) clearTimeout(alarmTimeout);
            alarmTimeout = null;

            // UI Normal
            aiStatus.innerText = "VIGILANCIA ACTIVA";
            aiStatus.className = "text-sm font-bold text-green-400";
            alarmOverlay.classList.add('hidden');
            stopBtn.classList.add('hidden');
        }

        // 4. FUNCIONES GLOBALES (ACCESIBLES DESDE HTML)
        
        window.stopAlarmManually = function() {
            addLog("üîï Alarma detenida manualmente.", "info");
            resetAlarmState();
        };

        window.setupCamera = async function() {
            try {
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(t => t.stop());
                }
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode, width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });
                video.srcObject = stream;
                video.addEventListener("loadeddata", () => {
                   if(!objectDetector) initializeObjectDetector();
                });
            } catch (err) {
                addLog("Error Camara: " + err.message, "alert");
            }
        };

        window.switchCamera = function() {
            currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
            window.setupCamera();
        };

        window.toggleWakeLock = async function() {
            const btn = document.getElementById('wakelock-btn');
            const status = document.getElementById('wake-state');
            if (!('wakeLock' in navigator)) return alert("No soportado");

            if (wakeLock) {
                await wakeLock.release();
                wakeLock = null;
                status.innerText = "OFF";
                btn.classList.remove('border-green-500', 'text-green-400');
                btn.classList.add('border-yellow-600/50');
            } else {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    status.innerText = "ON";
                    status.className = "text-green-400 font-bold";
                    btn.classList.remove('border-yellow-600/50');
                    btn.classList.add('border-green-500', 'text-green-400');
                    addLog("‚úÖ Pantalla Bloqueada");
                } catch (e) {}
            }
        };

        // Iniciar
        window.setupCamera();
    </script>
</body>
</html>