<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:,">
    <title>Sentinel AI v2.6 - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry { animation: fadeIn 0.2s ease-in; border-bottom: 1px solid #333; padding: 4px 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        html, body { overscroll-behavior-y: contain; touch-action: manipulation; background: #0a0a0a; }
        #webcam { filter: brightness(1.1) contrast(1.1); }
        #roi-canvas { cursor: crosshair; touch-action: none; }
    </style>
</head>
<body class="text-green-400 font-mono p-4 text-center min-h-screen flex flex-col items-center select-none">
    
    <h1 class="text-2xl font-bold mb-3 text-red-500 uppercase tracking-tighter animate-pulse">锔 Sentinel AI Security</h1>
    
    <div class="relative inline-block border-2 border-green-600 shadow-[0_0_15px_rgba(0,255,0,0.3)] bg-black rounded-lg overflow-hidden">
        <video id="webcam" autoplay playsinline muted class="w-[480px] max-w-full h-auto"></video>
        <canvas id="roi-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
        
        <div id="recording-dot" class="absolute top-2 right-2 w-3 h-3 bg-red-600 rounded-full animate-ping"></div>
        <div class="absolute bottom-2 left-2 bg-black/70 px-2 py-1 text-[10px] text-white">ZONA: <span id="roi-coords">TODO EL CUADRO</span></div>
    </div>

    <div class="flex gap-2 mt-3 flex-wrap justify-center">
        <button onclick="switchCamera()" class="bg-blue-600 active:bg-blue-800 text-white px-4 py-2 rounded text-sm font-bold"> Girar</button>
        <button onclick="resetROI()" class="bg-gray-600 active:bg-gray-800 text-white px-4 py-2 rounded text-sm font-bold"> Reset Zona</button>
        <button id="wake-lock-btn" onclick="toggleWakeLock()" class="bg-amber-600 active:bg-amber-800 text-white px-4 py-2 rounded text-sm font-bold"> Pantalla</button>
    </div>

    <div class="mt-4 w-full max-w-4xl bg-gray-900 border border-gray-700 rounded-lg overflow-hidden text-left shadow-2xl">
        <div class="bg-gray-800 p-2 flex justify-between items-center px-4">
            <span id="dash-status" class="text-xs font-bold flex items-center">
                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2 animate-pulse"></span> SISTEMA LISTO
            </span>
            <span id="dash-clock" class="text-xs text-yellow-500">00:00:00</span>
        </div>
        
        <div class="p-3 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="md:col-span-2 bg-black p-3 rounded border border-gray-800">
                <p class="text-[10px] text-gray-500 uppercase mb-1">Detecci贸n IA:</p>
                <div id="dash-analysis" class="text-xs text-white leading-relaxed italic">Dibuja una zona para empezar...</div>
            </div>
            <div class="bg-black p-3 rounded border border-gray-800 h-32 overflow-y-auto">
                <p class="text-[10px] text-gray-500 uppercase mb-1">Logs:</p>
                <div id="log-container" class="text-[9px] text-gray-400"></div>
            </div>
        </div>
    </div>

    <canvas id="hidden-canvas" class="hidden"></canvas>
    <audio id="alarm-sound" loop preload="auto">
        <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    </audio>

<script>
    const RENDER_API_URL = "https://seguridad-thxq.onrender.com/analyze"; 
    const MOTION_THRESHOLD = 20; 
    const ANALYZE_COOLDOWN = 2000; 

    let previousFrameData = null;
    let isAnalyzing = false;
    let currentFacingMode = "environment";
    let wakeLock = null;
    let roi = null;
    let isDrawing = false;
    let startX, startY;

    const video = document.getElementById('webcam');
    const roiCanvas = document.getElementById('roi-canvas');
    const hiddenCanvas = document.getElementById('hidden-canvas');
    const logContainer = document.getElementById('log-container');
    const dashAnalysis = document.getElementById('dash-analysis');
    const dashStatus = document.getElementById('dash-status');
    const alarmAudio = document.getElementById('alarm-sound');

    // --- GESTIN DE ALARMA ---
    function manageAlarm(play) {
        if (play) {
            alarmAudio.play().catch(e => console.log("Esperando interacci贸n del usuario para audio"));
        } else {
            alarmAudio.pause();
            alarmAudio.currentTime = 0; // Reinicia el sonido
        }
    }

    // --- SELECCIN DE REGIN (ROI) ---
    function getCoords(e) {
        const rect = roiCanvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return [(clientX - rect.left) / rect.width, (clientY - rect.top) / rect.height];
    }

    roiCanvas.addEventListener('pointerdown', e => {
        isDrawing = true;
        [startX, startY] = getCoords(e);
        roi = { x: startX, y: startY, w: 0, h: 0 };
    });

    window.addEventListener('pointermove', e => {
        if (!isDrawing) return;
        const [currX, currY] = getCoords(e);
        roi.w = currX - startX;
        roi.h = currY - startY;
        drawROIGuide();
    });

    window.addEventListener('pointerup', () => {
        if (!isDrawing) return;
        isDrawing = false;
        if (Math.abs(roi.w) < 0.05) { resetROI(); return; } // Evitar cuadros min煤sculos
        if (roi.w < 0) { roi.x += roi.w; roi.w = Math.abs(roi.w); }
        if (roi.h < 0) { roi.y += roi.h; roi.h = Math.abs(roi.h); }
        document.getElementById('roi-coords').innerText = "ZONA ACTIVA";
        addLog("Zona de vigilancia definida");
    });

    function drawROIGuide() {
        const ctx = roiCanvas.getContext('2d');
        ctx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
        if (!roi) return;
        ctx.strokeStyle = '#00ff00';
        ctx.setLineDash([5, 5]);
        ctx.strokeRect(roi.x * roiCanvas.width, roi.y * roiCanvas.height, roi.w * roiCanvas.width, roi.h * roiCanvas.height);
    }

    function resetROI() {
        roi = null;
        roiCanvas.getContext('2d').clearRect(0, 0, roiCanvas.width, roiCanvas.height);
        document.getElementById('roi-coords').innerText = "TODO EL CUADRO";
        addLog("Zona reiniciada");
    }

    // --- ANLISIS ---
    async function analyzeFrame() {
        if (isAnalyzing) return;

        const vW = video.videoWidth;
        const vH = video.videoHeight;
        if (!vW) { setTimeout(analyzeFrame, 500); return; }

        const area = roi || { x: 0, y: 0, w: 1, h: 1 };
        const ctx = hiddenCanvas.getContext('2d', { willReadFrequently: true });
        
        hiddenCanvas.width = 100; hiddenCanvas.height = 100;
        ctx.drawImage(video, area.x * vW, area.y * vH, area.w * vW, area.h * vH, 0, 0, 100, 100);
        const currentFrame = ctx.getImageData(0, 0, 100, 100).data;

        let hasMotion = false;
        if (previousFrameData) {
            let diff = 0;
            for (let i = 0; i < currentFrame.length; i += 8) {
                if (Math.abs(currentFrame[i] - previousFrameData[i]) > MOTION_THRESHOLD) diff++;
            }
            if (diff > 50) hasMotion = true;
        }
        previousFrameData = currentFrame;

        if (!hasMotion) {
            updateStatus("ESCANEANDO ZONA", "text-gray-500", "bg-gray-700");
            manageAlarm(false); // SILENCIO si no hay movimiento
            setTimeout(analyzeFrame, 400);
            return;
        }

        isAnalyzing = true;
        updateStatus("ANALIZANDO...", "text-yellow-500", "bg-yellow-500");

        hiddenCanvas.width = 480; hiddenCanvas.height = 480 * (area.h / area.w);
        ctx.drawImage(video, area.x * vW, area.y * vH, area.w * vW, area.h * vH, 0, 0, hiddenCanvas.width, hiddenCanvas.height);
        
        try {
            const response = await fetch(RENDER_API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ image: hiddenCanvas.toDataURL("image/jpeg", 0.7) })
            });
            const data = await response.json();
            
            dashAnalysis.innerText = data.description || "Sin descripci贸n";
            if (data.suspicious) {
                addLog(" AMENAZA DETECTADA", "alert");
                manageAlarm(true); // SONAR solo si es sospechoso
                updateStatus("锔 PELIGRO", "text-red-500", "bg-red-600");
            } else {
                manageAlarm(false); // SILENCIO si no es peligroso
                updateStatus("ZONA SEGURA", "text-green-400", "bg-green-500");
            }
        } catch (e) {
            addLog("Error de conexi贸n");
            manageAlarm(false);
        } finally {
            isAnalyzing = false;
            setTimeout(analyzeFrame, ANALYZE_COOLDOWN);
        }
    }

    // --- FUNCIONES DE CONTROL (CORREGIDAS) ---
    window.toggleWakeLock = async function() {
        const btn = document.getElementById('wake-lock-btn');
        if (wakeLock) {
            await wakeLock.release();
            wakeLock = null;
            btn.classList.replace('bg-green-600', 'bg-amber-600');
            addLog("Ahorro energ铆a activo");
        } else {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                btn.classList.replace('bg-amber-600', 'bg-green-600');
                addLog("Pantalla Bloqueada (Siempre ON)");
            } catch (err) { addLog("Error WakeLock"); }
        }
    };

    window.switchCamera = () => {
        if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
        setupCamera();
    };

    async function setupCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: currentFacingMode, width: 1280, height: 720 } 
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                roiCanvas.width = video.clientWidth;
                roiCanvas.height = video.clientHeight;
                analyzeFrame();
            };
        } catch (e) { addLog("Error c谩mara", "alert"); }
    }

    function addLog(msg, type='info') {
        const div = document.createElement('div');
        div.className = `log-entry ${type==='alert'?'text-red-500':'text-gray-500'}`;
        div.innerText = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}`;
        logContainer.prepend(div);
    }

    function updateStatus(text, colorClass, pingColor) {
        dashStatus.innerHTML = `<span class="w-2 h-2 ${pingColor} rounded-full mr-2 animate-ping"></span> ${text}`;
        dashStatus.className = `text-xs font-bold flex items-center ${colorClass}`;
    }

    setInterval(() => { document.getElementById('dash-clock').innerText = new Date().toLocaleTimeString(); }, 1000);
    setupCamera();
</script>
</body>
</html>